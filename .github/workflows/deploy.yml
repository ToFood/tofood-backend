name: Deploy üåê

on:
  push:
    branches:
      - main
      - develop

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ vars.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
  IMAGE_NAME: "tofood/backend"
  CLUSTER_NAME: "tofood-eks-cluster"
  DEPLOYMENT_NAME: "tofood-deployment"
  NODEGROUP_NAME: "tofood-nodegroup"

jobs:
  # Job de Build do Projeto Node/TypeScript
  build_project:
    name: Build do Projeto Node/TypeScript
    runs-on: ubuntu-latest

    steps:
      - name: üé® Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üì¶ Instalar depend√™ncias
        run: |
          npm install

      - name: üõ†Ô∏è Build do projeto
        run: |
          npm run build

      - name: ‚úÖ Verificar erros de build e lint
        run: |
          npm run lint
          npm test

  # Job de Configura√ß√£o Inicial
  setup:
    name: Configura√ß√£o Inicial
    runs-on: ubuntu-latest
    needs: build_project

    steps:
      - name: üé® Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üîê Configurar credenciais da AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ env.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

  # Job de Infraestrutura EKS
  eks_infrastructure:
    name: Gerenciamento da Infraestrutura EKS
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: üîë Verificar e aplicar pol√≠tica de permiss√£o
        run: |
          POLICY_ARN="arn:aws:iam::${AWS_ACCOUNT_ID}:policy/CustomPutRolePolicyPermission"
          if ! aws iam get-policy --policy-arn $POLICY_ARN 2>/dev/null; then
            echo "Criando pol√≠tica personalizada para iam:PutRolePolicy..."
            aws iam create-policy \
              --policy-name CustomPutRolePolicyPermission \
              --policy-document '{
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": "iam:PutRolePolicy",
                    "Resource": "*"
                  }
                ]
              }'
          fi
          echo "Anexando a pol√≠tica √† role de execu√ß√£o..."
          aws iam attach-role-policy \
            --role-name GitHubActionsRole \
            --policy-arn $POLICY_ARN

      - name: üõ†Ô∏è Criar cluster EKS (se n√£o existir)
        run: |
          if ! aws eks describe-cluster --name $CLUSTER_NAME --region $AWS_REGION; then
            echo "Cluster n√£o encontrado. Criando cluster EKS..."
            aws eks create-cluster \
              --name $CLUSTER_NAME \
              --region $AWS_REGION \
              --kubernetes-version "1.21" \
              --role-arn arn:aws:iam::${AWS_ACCOUNT_ID}:role/EKSClusterRole \
              --resources-vpc-config subnetIds=subnet-xxxxxx,subnet-yyyyyy,securityGroupIds=sg-zzzzzz
            aws eks wait cluster-active --name $CLUSTER_NAME --region $AWS_REGION
          else
            echo "Cluster EKS j√° existe."
          fi

      - name: üõ†Ô∏è Criar NodeGroup (se n√£o existir)
        run: |
          if ! aws eks describe-nodegroup --cluster-name $CLUSTER_NAME --nodegroup-name $NODEGROUP_NAME --region $AWS_REGION; then
            echo "NodeGroup n√£o encontrado. Criando NodeGroup..."
            aws eks create-nodegroup \
              --cluster-name $CLUSTER_NAME \
              --nodegroup-name $NODEGROUP_NAME \
              --node-role arn:aws:iam::${AWS_ACCOUNT_ID}:role/EKSNodeRole \
              --subnets subnet-xxxxxx subnet-yyyyyy \
              --scaling-config minSize=1,maxSize=3,desiredSize=2 \
              --instance-types t3.medium \
              --region $AWS_REGION
            aws eks wait nodegroup-active --cluster-name $CLUSTER_NAME --nodegroup-name $NODEGROUP_NAME --region $AWS_REGION
          else
            echo "NodeGroup j√° existe."
          fi

  # Job de Cria√ß√£o do Reposit√≥rio ECR
  ecr_setup:
    name: Configura√ß√£o do ECR
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: üõ†Ô∏è Criar reposit√≥rio ECR (se n√£o existir)
        run: |
          aws ecr describe-repositories --repository-names "$IMAGE_NAME" --region $AWS_REGION || \
          aws ecr create-repository --repository-name "$IMAGE_NAME" --region $AWS_REGION

      - name: üêã Login no Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

  # Job de Build e Push da Imagem Docker
  docker_build_push:
    name: Build e Push da Imagem Docker
    runs-on: ubuntu-latest
    needs: ecr_setup

    steps:
      - name: üõ†Ô∏è Build da imagem Docker
        run: |
          docker build -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest .

      - name: üè∑Ô∏è Tag da imagem
        run: |
          docker tag $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:${{ github.sha }}

      - name: üì§ Push da imagem Docker
        run: |
          docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest
          docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:${{ github.sha }}

  # Job de Deploy no EKS
  eks_deploy:
    name: Deploy no EKS
    runs-on: ubuntu-latest
    needs: [eks_infrastructure, docker_build_push]

    steps:
      - name: ‚öôÔ∏è Configurar kubectl
        run: |
          aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME

      - name: üöÄ Atualizar deployment no EKS
        run: |
          kubectl set image deployment/$DEPLOYMENT_NAME tech-challenge-container=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest
          kubectl rollout status deployment/$DEPLOYMENT_NAME

      - name: üñ•Ô∏è Mostrar as inst√¢ncias do cluster
        run: |
          kubectl get nodes
