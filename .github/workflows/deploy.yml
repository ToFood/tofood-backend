name: Build, Push, and Deploy to AWS EKS

on:
  push:
    branches:
      - '**'

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ vars.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}  # Inclu√≠do o token de sess√£o
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
      IMAGE_NAME: "tofood/backend"
      CLUSTER_NAME: "tofood-cluster-back"  # Substitua pelo nome do seu cluster EKS
      DEPLOYMENT_NAME: "tofood-deployment"  # Nome do seu Deployment no EKS

    steps:
      # Fazer checkout do c√≥digo-fonte
      - name: üé® Fazer checkout do reposit√≥rio
        uses: actions/checkout@v4

      # Configurar as credenciais da AWS
      - name: üîê Configurar credenciais da AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}  # Passar o token de sess√£o
          aws-region: ${{ vars.AWS_REGION }}

      # Adicionar etapa de cria√ß√£o do reposit√≥rio no ECR
      - name: üõ†Ô∏è Criar reposit√≥rio ECR (se n√£o existir)
        run: |
          aws ecr describe-repositories --repository-names "tofood/backend" --region $AWS_REGION || \
          aws ecr create-repository --repository-name "tofood/backend" --region $AWS_REGION

      # Login no Amazon ECR
      - name: üêã Login no Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # Build da imagem Docker
      - name: üõ†Ô∏è Build da imagem Docker
        run: |
          docker build -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest .

      # Tag da imagem com o SHA do commit
      - name: üè∑Ô∏è Tag da imagem
        run: |
          docker tag $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:${{ github.sha }}

      # Push da imagem para o Amazon ECR
      - name: üì§ Push da imagem Docker
        run: |
          docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest
          docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:${{ github.sha }}

      # Configurar o kubectl
      - name: ‚öôÔ∏è Configurar kubectl
        run: |
          aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME

      # Atualizar o Deployment no Kubernetes (EKS)
      - name: üöÄ Atualizar deployment no EKS
        run: |
          kubectl set image deployment/$DEPLOYMENT_NAME tech-challenge-container=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME:latest
          kubectl rollout status deployment/$DEPLOYMENT_NAME

      # Mostrar as inst√¢ncias no cluster
      - name: üñ•Ô∏è Mostrar as inst√¢ncias do cluster
        run: |
          kubectl get nodes
